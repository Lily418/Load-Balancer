<!doctype html>
<html>
<head>
    <title>CPU Usage</title>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="https://dl.dropboxusercontent.com/u/36831702/js/highcharts.js"></script>
    <script src="https://dl.dropboxusercontent.com/u/36831702/js/modules/exporting.js"></script>
    <script src="https://dl.dropboxusercontent.com/u/36831702/js/hc.js"></script>
    <script src="https://dl.dropboxusercontent.com/u/36831702/js/highchart-helper.js"></script>

    <script>
    $(function(){

        var socket = io.connect("http://192.168.56.101:3000");
        var connectedToLoadSim = false;


        createChart('#container', 'CPU_Usage', 'datetime', 100, "Time", "Usage %");
        createChart('#container2', 'Optimal_Servers', 'linear', 10, "Time Slice", "No. Of Servers");
        createChart('#responseTime', 'Response_Time', 'datetime', 3, "Time", "Seconds");

        function connectToLoadSim(){
            connectedToLoadSim = true;
            var webSocket = new WebSocket("ws://127.0.0.1:9000/ws");
            webSocket.onopen = function (event) {
                webSocket.send("Socket Open")
            }

            webSocket.onmessage = function (event) {
                if(Response_Time === undefined){
                    return;
                }

                if(Response_Time.get("ResponseTime") == null) {
                    Response_Time.addSeries({
                        name: "Response Time",
                        id: "ResponseTime",
                        data: []
                    });
                }


                Response_Time.get("ResponseTime").addPoint([new Date().getTime(), Number(event.data)], true, false, true);
            }

            webSocket.onclose = function(event){
                connectedToLoadSim = false;
            }
        }

        function createChart(id, title, xAxisType, max, xAxisLabel, yAxisLabel){
            $(id).highcharts({
                chart: {
                    type: 'spline',
                    marginRight: 10,
                    events: {
                        load: function () {
                            window[title] = this;
                        }
                    }
                },
                title: {
                    text: title
                },

                yAxis: {
                    title: {
                        text: yAxisLabel
                    },
                    plotLines: [{
                        value: 0,
                        width: 1,
                        color: '#808080'
                    }],
                    min: 0,
                    max: max,
                    allowDecimals: false
                },
                xAxis: {
                    title: {
                        text: xAxisLabel
                    },
                    type: xAxisType,
                    tickPixelInterval: 100,
                    allowDecimals: false
                },
                tooltip: {
                    formatter: function () {
                        return '<b>' + this.series.name + '</b><br/>' +
                        Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br/>' +
                        Highcharts.numberFormat(this.y, 2);
                    }
                }
            });
        }




        socket.on('cpu-ip', function(msg){
            msg = JSON.parse(msg);

            if(CPU_Usage === undefined){
                console.log('chart undefined');
                return;
            }

            var series = CPU_Usage.get(msg.ip);

            if(series == null) {
                CPU_Usage.addSeries({
                    name: "Load for " + msg.ip,
                    id: msg.ip,
                    data: []
                });

                series = CPU_Usage.get(msg.ip);
            }

            series.addPoint([(new Date()).getTime(), parseFloat(msg.usage)], true, false, true);


            var min = new Date().setMinutes(new Date().getMinutes() - 3);
            var max = new Date().setMinutes(new Date().getMinutes() + 1);
            CPU_Usage.xAxis[0].setExtremes(min, max);


        });

        socket.on('optimal-servers', function(msg){

            if(!connectedToLoadSim){
                connectToLoadSim();
            }

            msg = JSON.parse(msg);
            if(Optimal_Servers === undefined){
                return;
            }

            var series = Optimal_Servers.get(msg.series);

            if(series == null) {
                Optimal_Servers.addSeries({
                    name: msg.series,
                    id: msg.series,
                    data: []
                });

                series = Optimal_Servers.get(msg.series);
            }

            //console.log(msg);

            series.addPoint(msg.optimalServers);
            Optimal_Servers.xAxis[0].setExtremes(0, 100);
        });

        function addMlData(chart){
            socket.on('ml-data', function(msg){
                console.log(msg)
                chart.get('opt-servers').addPoint(JSON.parse(msg));
            });
        }

        function planeEquationToDrawingPosition(w2, w1, w0){

        }


        var plane = null;
        var planeA = 10;
        var planeB = 30;
        var bias = 0;
        var alphaSlope = 10;
        function render(chart, a, b){
            //console.log('Trying to render');
            if(plane != null){
                console.log(a + " " + b);
                plane.destroy();
            }

            plane = chart.renderer.cuboid( {
                "x":100,
                "y":700 - (bias * 60),
                "z":0,
                "width":600,
                "height":1,
                "depth":250,
                "alpha":a + 0,
                "beta":b + 0,
                "origin":{"x":400,"y":400,"z":250,"vd":5}})
            .attr({
                fill: 'rgba(255,0,0,100)' ,
                zIndex: 0
            })
            .add();
        }

        function defaultData(empty){

            if(empty){
                return []
            }
            else {
                return [[3,2,2],[3,2,2],[4,2,2],[4,2,2],[3,2,2],[3,2,2],[3,2,2],[3,2,2],[3,2,2],[3,2,2],[3,2,1],[3,1,2],[3,2,2],[3,2,2],[3,2,1],[3,1,1],[3,1,1],[3,1,1],[3,1,1],[3,1,1],[2,1,1],[2,1,1],[2,1,1],[2,1,1],[2,1,1],[2,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[2,1,1],[2,1,1],[2,1,1],[2,1,1],[2,1,1],[2,1,1],[2,1,1],[2,1,1],[2,1,2],[2,2,2],[2,2,2],[3,2,2],[3,2,2],[3,2,2],[4,2,3],[4,3,3],[4,3,3],[5,3,3],[4,3,3],[5,3,3],[5,3,3],[5,3,3],[5,3,3],[5,3,3],[5,3,3],[5,3,3],[6,3,3],[6,3,3],[6,3,3],[6,3,3],[6,3,3],[6,3,3],[6,3,3],[6,3,3],[6,3,3],[6,3,3],[6,3,3],[6,3,3],[6,3,3],[6,3,3],[6,3,3],[5,3,3],[5,3,3],[5,3,3],[5,3,3],[5,3,3],[5,3,3],[5,3,3],[5,3,3],[5,3,3],[5,3,3],[5,3,3],[5,3,3],[4,3,2],[4,2,2],[4,2,2],[4,2,2],[4,2,2],[4,2,2],[3,2,1],[3,1,1],[4,1,1],[3,1,1],[3,1,2],[3,2,1],[3,1,1],[3,1,1],[3,1,1]];
            }
        }

        Highcharts.getOptions().colors = $.map(Highcharts.getOptions().colors, function (color) {
            return {
                radialGradient: {
                    cx: 0.4,
                    cy: 0.3,
                    r: 0.5
                },
                stops: [
                [0, color],
                [1, Highcharts.Color(color).brighten(-0.2).get('rgb')]
                ]
            };
        });

        var ml_vis = $('#ml-vis').highcharts({
            chart: {
                type: 'scatter',
                margin: 100,
                options3d: {
                    enabled: true,
                    alpha: 25,
                    beta: 30,
                    depth: 250,
                    viewDistance: 5,

                    frame: {
                        bottom: { size: 1, color: 'rgba(0,0,0,0.02)' },
                        back: { size: 1, color: 'rgba(0,0,0,0.04)' },
                        side: { size: 1, color: 'rgba(0,0,0,0.06)' }
                    }
                },

                events: {
                    load: function () {
                        var c = this;
                        addMlData(this);
                        //c.options.chart.options3d.alpha = 0;
                        //c.options.chart.options3d.beta = 0;
                        //chart.redraw(false);

                        render(this, c.options.chart.options3d.alpha, c.options.chart.options3d.beta);
                        setRotation(this, function(showLabels){
                            c.yAxis[0].axisTitle.attr({
                                text: ''
                            });

                            c.xAxis[0].axisTitle.attr({
                                text: ''
                            });

                            if(showLabels) {
                                c.yAxis[0].axisTitle.attr({
                                    text: 'T-1 Hour'
                                });

                                c.xAxis[0].axisTitle.attr({
                                    text: 'T-1 Year'
                                });
                            }

                        }, function(alpha, beta){
                            render(c, alpha, beta);
                        });
                    }
                }
            },

            yAxis: {
                min: 0,
                max: 10,
                gridLineWidth: 1,
                title: {
                    text: "T-1 Hour"
                }


            },
            xAxis: {
                min: 0,
                max: 10,
                gridLineWidth: 1,
                title: {
                    text: "T-1 Year"
                }

            },
            zAxis: {
                min: 0,
                max: 10,
                gridLineWidth: 1,
                title: {
                    text: "T"
                }

            },

            plotOptions: {
                scatter: {
                    width: 10,
                    height: 10,
                    depth: 10
                }
            },

            series: [{
                id: 'opt-servers',
                name: '(T-1 Year, T-1 Hour, T)',
                colorByPoint: true,
                data: defaultData(false)
            }]
        });

    });

    </script>
</head>
<body>
    <div id="container" style="width: 49%; height: 380px; float:left;"></div>
    <div id="responseTime" style="width: 49%; height: 380px; float:right;"></div>
    <div id="container2" style="min-width: 310px; height: 400px; margin: 0 auto; clear:both;"></div>

    <div id="ml-vis" style="margin-left:auto; margin-right: auto; height: 800px; width:800px;"></div>

</body>
</body>
</html>
